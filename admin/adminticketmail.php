<?php/*  Template Name: adminticketemail.php */require_once( WP_PLUGIN_DIR . '/key4ce-osticket-bridge/includes/functions.php'); //echo "SELECT user_id FROM " . $keyost_prefix . "user_email WHERE `address` = '" . $_REQUEST['email'] . "'";$user_id=$ost_wpdb->get_var("SELECT user_id FROM " . $keyost_prefix . "user_email WHERE `address` = '" . $_REQUEST['email'] . "'");$wp_user_email_id = $_REQUEST['email'];$tic_ID = key4ce_generateID();$top_id="";$checkUserID = $ost_wpdb->get_results("SELECT number from $ticket_table WHERE number = '$tic_ID'");if (count($checkUserID) > 0) {    $tic_ID = key4ce_generateID();}$dep_id = $_REQUEST['deptId'];if($keyost_version==1914){	$ticket_sender=$ost_wpdb->get_row("SELECT $ost_email.name,$ost_email.email from $dept_tableINNER JOIN $ost_email on $ost_email.email_id=$dept_table.email_idWHERE $dept_table.id=$dep_id");}else{	$ticket_sender=$ost_wpdb->get_row("SELECT $ost_email.name,$ost_email.email from $dept_tableINNER JOIN $ost_email on $ost_email.email_id=$dept_table.email_idWHERE $dept_table.dept_id=$dep_id");}if($ticket_sender->email_id==0){    $default_email_id=key4ce_getKeyValue('default_email_id');    $ticket_dept_details=$ost_wpdb->get_row("SELECT email,name  FROM  $ost_email WHERE `email_id` = $default_email_id");    $ticket_detail_dept_name=$ticket_dept_details->name;    $ticket_detail_dept_email=$ticket_dept_details->email;}else{    $ticket_detail_dept_name=$ticket_sender->name;    $ticket_detail_dept_email=$ticket_sender->email;}$sla_id = 1;$pri_id = $_REQUEST['priorityId'];//@$top_id = $_REQUEST['topicId'];if(@$_REQUEST['topicId']==""){	$top_id=0;}else{	$top_id = $_REQUEST['topicId'];}$staff_id = 0;$team_id = 0;$usid = $user_id;$em = $_REQUEST['email'];$nam = $_REQUEST['username'];$nam = preg_replace('/[^\p{L}\p{N}\s]/u', '', $nam);$adem = $_REQUEST['ademail'];$title = $_REQUEST['stitle'];$dirname = $_REQUEST['sdirna'];@$sub = Format::stripslashes($_REQUEST['subject']);@$newtickettemp = Format::stripslashes($_REQUEST['newtickettemp']);$ip_add = $_SERVER['REMOTE_ADDR'];if($keyost_version==194 || $keyost_version==195 || $keyost_version==1951 || $keyost_version==1914){$ticketstate = "1";}else{	$ticketstate = "open";	}$sour = "Web";$isoverdue = 0;$isans = 0;$my_unix_timestamp=current_time('mysql');$las_msg =get_date_from_gmt( date( 'Y-m-d H:i:s', strtotime($my_unix_timestamp)), 'Y-m-d H:i:s' ); $cre =get_date_from_gmt( date( 'Y-m-d H:i:s', strtotime($my_unix_timestamp)), 'Y-m-d H:i:s' );@$user_message = Format::stripslashes($_REQUEST['message']);$prid = $ost_wpdb->get_row("SELECT priority_desc FROM $priority_table WHERE priority_id=$pri_id");$priordesc = $prid->priority_desc;// Added by Pratik Maniar on 29-04-2014 Start Here  if($keyost_version==1914)	{		$dept_details = $ost_wpdb->get_row("SELECT id,name FROM $dept_table WHERE id=$dep_id");		$dept_name = $dept_details->name;	}	else	{		$dept_details = $ost_wpdb->get_row("SELECT dept_id,dept_name FROM $dept_table WHERE dept_id=$dep_id");		$dept_name = $dept_details->dept_name;	}// Start File system changesif($keyost_version==193){    $attachement_status=key4ce_getKeyValue('allow_attachments');    $max_user_file_uploads=key4ce_getKeyValue('max_user_file_uploads');    $max_file_size=key4ce_getKeyValue('max_file_size');    $fileextesnions=key4ce_getKeyValue('allowed_filetypes');}else{    $fileconfig=key4ce_FileConfigValue();    $filedata=json_decode($fileconfig);    $attachement_status=$filedata->attachments;    $max_user_file_uploads=$filedata->max;    $max_file_size=$filedata->size;    $fileextesnions=$filedata->extensions;}	// End file system changes/////New user info > check if user exists or create a new user...$result1 = $ost_wpdb->get_results("SELECT address FROM " . $keyost_prefix . "user_email WHERE address = '" . $wp_user_email_id . "'");if (count($result1) > 0) {    $row = current($result1);} else {    $ost_wpdb->query("INSERT INTO " . $keyost_prefix . "user_email (id, user_id, address) VALUES ('','" . $usid . "','" . $wp_user_email_id . "')");    @$last_ost_user_email_id = $ost_wpdb->insert_id;}$result2 = $ost_wpdb->get_results("SELECT default_email_id,name FROM " . $keyost_prefix . "user WHERE default_email_id = '" . @$last_ost_user_email_id . "'");if (count($result2) > 0) {    //$row = current ($result2);    @$name = $result2->name;    if (@$name == "") {        if (@$last_ost_user_email_id != "")            $wpdb->query("UPDATE " . $keyost_prefix . "user SET name = " . $nam . " WHERE default_email_id = '" . @$last_ost_user_email_id . "'");    }} else {    $ost_wpdb->query("INSERT INTO " . $keyost_prefix . "user (id, default_email_id, name, created, updated) VALUES ('','" . $last_ost_user_email_id . "', '" . $nam . "', '" . $cre . "', '" . $cre . "')");    $last_ost_user_id = $ost_wpdb->insert_id;    if ($last_ost_user_id != "")        $ost_wpdb->query("UPDATE " . $keyost_prefix . "user_email SET user_id=$last_ost_user_id where id=$last_ost_user_email_id");}////End of new user info user_email_id email_idif (count($result1) > 0) {	if($keyost_version==194 || $keyost_version==195 || $keyost_version==1951)	{		$ost_wpdb->insert($ticket_table, array('number' => $tic_ID, 'user_id' => $usid, 'user_email_id' => $usid, 'dept_id' => $dep_id, 'sla_id' => $sla_id, 'topic_id' => $top_id, 'staff_id' => $staff_id, 'team_id' => $team_id, 'email_id' => $usid, 'ip_address' => $ip_add, 'status_id' => $ticketstate, 'source' => $sour, 'isoverdue' => $isoverdue, 'isanswered' => $isans, 'lastmessage' => $las_msg, 'created' => $cre), array('%d', '%d', '%d', '%d', '%d', '%d', '%d', '%d', '%d', '%s', '%s', '%s', '%s', '%s', '%s', '%s'));	}	else if($keyost_version==1914)	{		$lock_id=0;		$flags=0;		$est_duedate=$cre;		$lastupdate=$cre;		$source_extra=null;		$ost_wpdb->insert($ticket_table, array('number' => $tic_ID, 'user_id' => $usid, 'user_email_id' => $usid,'status_id' => $ticketstate,'dept_id' => $dep_id, 'sla_id' => $sla_id, 'topic_id' => $top_id, 'staff_id' => $staff_id, 'team_id' => $team_id, 'email_id' => $usid,'lock_id'=>$lock_id ,'flags'=>$flags,'ip_address' => $ip_add, 'source' => $sour,'source_extra'=>$source_extra ,'isoverdue' => $isoverdue, 'isanswered' => $isans,'duedate'=>$duedate,'est_duedate'=>$est_duedate,'lastupdate'=>$lastupdate,'created' => $cre,'updated'=>$cre), array('%d', '%d', '%d', '%d', '%d', '%d', '%d', '%d', '%d','%d','%d','%d','%s','%s', '%s', '%s','%s','%s','%s','%s', '%s','%s'));	}	else	{		$ost_wpdb->insert($ticket_table, array('number' => $tic_ID, 'user_id' => $usid, 'user_email_id' => $usid, 'dept_id' => $dep_id, 'sla_id' => $sla_id, 'topic_id' => $top_id, 'staff_id' => $staff_id, 'team_id' => $team_id, 'email_id' => $usid, 'ip_address' => $ip_add, 'status' => $ticketstate, 'source' => $sour, 'isoverdue' => $isoverdue, 'isanswered' => $isans, 'lastmessage' => $las_msg, 'created' => $cre), array('%d', '%d', '%d', '%d', '%d', '%d', '%d', '%d', '%d', '%s', '%s', '%s', '%s', '%s', '%s', '%s'));	}} else {	if($keyost_version==194 || $keyost_version==195 || $keyost_version==1951){		$ost_wpdb->insert($ticket_table, array('number' => $tic_ID, 'user_id' => $last_ost_user_id, 'user_email_id' => $last_ost_user_email_id, 'dept_id' => $dep_id, 'sla_id' => $sla_id, 'topic_id' => $top_id, 'staff_id' => $staff_id, 'team_id' => $team_id, 'email_id' => $last_ost_user_email_id, 'ip_address' => $ip_add, 'status_id' => $ticketstate, 'source' => $sour, 'isoverdue' => $isoverdue, 'isanswered' => $isans, 'lastmessage' => $las_msg, 'created' => $cre), array('%d', '%d', '%d', '%d', '%d', '%d', '%d', '%d', '%d', '%s', '%s', '%s', '%s', '%s', '%s', '%s'));	}	else if($keyost_version==1914)	{		$lock_id=0;		$flags=0;		$est_duedate=$cre;		$lastupdate=$cre;		$source_extra=null;		$ost_wpdb->insert($ticket_table, array('number' => $tic_ID, 'user_id' => $last_ost_user_id, 'user_email_id' => $last_ost_user_email_id,'status_id' => $ticketstate,'dept_id' => $dep_id, 'sla_id' => $sla_id, 'topic_id' => $top_id, 'staff_id' => $staff_id, 'team_id' => $team_id, 'email_id' => $last_ost_user_email_id,'lock_id'=>$lock_id ,'flags'=>$flags,'ip_address' => $ip_add, 'source' => $sour,'source_extra'=>$source_extra ,'isoverdue' => $isoverdue, 'isanswered' => $isans,'duedate'=>$duedate,'est_duedate'=>$est_duedate,'lastupdate'=>$lastupdate,'created' => $cre,'updated'=>$cre), array('%d', '%d', '%d', '%d', '%d', '%d', '%d', '%d', '%d','%d','%d','%d','%s','%s', '%s', '%s','%s','%s','%s','%s', '%s','%s'));		//$ost_wpdb->insert($ticket_table, array('number' => $tic_ID, 'user_id' =>$last_ost_user_id, 'user_email_id' => $last_ost_user_email_id,'status_id' => $ticketstate,'dept_id' => $dep_id, 'sla_id' => $sla_id, 'topic_id' => $top_id, 'staff_id' => $staff_id, 'team_id' => $team_id, 'email_id' =>$last_ost_user_email_id,'lock_id'=>$lock_id ,'flags'=>$flags,'ip_address' => $ip_add, 'source' => $sour,'source_extra'=>$source_extra ,'isoverdue' => $isoverdue, 'isanswered' => $isans,'duedate'=>$duedate,'est_duedate'=>$est_duedate,'reopened'=>$reopened,'closed'=>$closed,'lastupdate'=>$lastupdate,'created' => $cre,'updated'=>$cre), array('%d', '%d', '%d', '%d', '%d', '%d', '%d', '%d', '%d','%d','%d','%d','%s','%s', '%s','%s','%s','%s','%s', '%s', '%s', '%s', '%s','%s'));		}	else	{		$ost_wpdb->insert($ticket_table, array('number' => $tic_ID, 'user_id' => $last_ost_user_id, 'user_email_id' => $last_ost_user_email_id, 'dept_id' => $dep_id, 'sla_id' => $sla_id, 'topic_id' => $top_id, 'staff_id' => $staff_id, 'team_id' => $team_id, 'email_id' => $last_ost_user_email_id, 'ip_address' => $ip_add, 'status' => $ticketstate, 'source' => $sour, 'isoverdue' => $isoverdue, 'isanswered' => $isans, 'lastmessage' => $las_msg, 'created' => $cre), array('%d', '%d', '%d', '%d', '%d', '%d', '%d', '%d', '%d', '%s', '%s', '%s', '%s', '%s', '%s', '%s'));	}}$lastid = $ost_wpdb->insert_id;$stat = "created";$staf = "SYSTEM";$annulled = 0;//$ost_wpdb->insert($ticket_event_table, array('ticket_id' => $lastid, 'staff_id' => $staff_id, 'team_id' => $team_id, 'dept_id' => $dep_id, 'topic_id' => $top_id, 'state' => $stat, 'staff' => $staf, 'annulled' => $annulled, 'timestamp' => $cre), array('%d', '%d', '%d', '%d', '%d', '%s', '%s', '%s', '%s'));// File Table Entry Code Start Here By Pratik Maniar on 29/08/2014if (!empty($_FILES['file']['name'][0])){      $fileids=array();   for ($i = 0; $i < count($_FILES['file']['name']); $i++){       $fullfinalpath= key4ce_getKeyValue('uploadpath');       $key4ce_generateHashKey = key4ce_generateHashKey(33);       $key4ce_generateHashSignature = key4ce_generateHashSignature(33);       $dir_name = substr($key4ce_generateHashKey, 0, 1);       $structure = $fullfinalpath."/".$dir_name;if (!is_dir($structure)) {    mkdir($structure, 0355);    }$alowaray = explode(".",str_replace(' ', '',$fileextesnions));$strplc = str_replace(".", "",str_replace(' ', '',$fileextesnions));$allowedExts = explode(",", $strplc);$allowextscnt=count($allowedExts);$temp = explode(".", $_FILES['file']['name'][$i]);$extension = end($temp); //return uploaded file extension$newfilename = $key4ce_generateHashKey;$realfilename = $_FILES['file']['name'][$i];$filetype = $_FILES["file"]["type"][$i];$filesize = $_FILES["file"]["size"][$i];if (($_FILES["file"]["size"][$i] < $max_file_size) && (in_array($extension, $allowedExts) || $allowextscnt)) {    if ($_FILES["file"]["error"][$i] > 0) {        echo "Return Code: " . $_FILES["file"]["error"][$i] . "<br>";        } else {            move_uploaded_file($_FILES["file"]["tmp_name"][$i], $structure . "/" . $newfilename);            }        }        $ost_wpdb->insert($keyost_prefix . "file", array('ft' => 'T', 'bk' => 'F', 'type' => $filetype,            'size' => $filesize, 'key' => $key4ce_generateHashKey, 'signature' => $key4ce_generateHashSignature,            'name' => $realfilename, 'attrs' => '', 'created' => $cre), array('%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s'));        $file_id = $ost_wpdb->insert_id;        array_push($fileids, $file_id);        }        }// File Table Entry Code End Here By Pratik Maniar on 29/08/2014  $pid = 0;$thread_type = "M";if($keyost_version==1914){	$flags= 65; //ost_config table id = 65 "show_assigned_tickets" is key	$ost_wpdb->insert($thread_table, array('object_id' => $lastid, 'object_type' => 'T', 'extra' => $extra, 'lastresponse' =>$lastresponse_time, 'lastmessage' => $las_msg,'created' => $cre), array('%d', '%s', '%s', '%s', '%s', '%s'));	$thread_id = $ost_wpdb->insert_id; 	//echo "Thread==>>".$ost_wpdb->last_query;	$ost_wpdb->insert($thread_entry, array('pid' => $pid,'thread_id' => $thread_id, 'staff_id' => $staff_id, 'user_id' => $usid,'type'=>$thread_type,'flags'=>$flags,'poster' => $nam,'source' => $sour, 'title' => $title, 'body' => key4ce_wpetss_forum_text($user_message),'format'=>'html', 'ip_address' => $ip_add, 'created' => $cre,'updated'=>$cre),array('%d','%d','%d','%d','%s','%d','%s','%s','%s','%s','%s','%s','%s','%s'));	//echo $ost_wpdb->last_query;}else{	$ost_wpdb->insert($thread_table, array('pid' => $pid, 'ticket_id' => $lastid, 'staff_id' => $staff_id, 'thread_type' => $thread_type, 'poster' => $nam, 'source' => $sour, 'title' => $title, 'body' => key4ce_wpetss_forum_text($user_message), 'ip_address' => $ip_add, 'created' => $cre), array('%d', '%d', '%d', '%s', '%s', '%s', '%s', '%s', '%s', '%s'));	$thread_id = $ost_wpdb->insert_id;}//$ost_wpdb->insert($thread_table, array('pid' => $pid, 'ticket_id' => $lastid, 'staff_id' => $staff_id, 'thread_type' => $thread_type, 'poster' => $nam, 'source' => $sour, 'title' => "", 'body' => key4ce_wpetss_forum_text($user_message), 'ip_address' => $ip_add, 'created' => $cre), array('%d', '%d', '%d', '%s', '%s', '%s', '%s', '%s', '%s', '%s'));//$thread_id = $ost_wpdb->insert_id;if($keyost_version==1914)	{		$ost_wpdb->insert($ticket_event_table, array('thread_id' => $thread_id, 'staff_id' => $staff_id, 'team_id' => $team_id, 'dept_id' => $dep_id,'topic_id' => $top_id, 'state' => $stat,'username' => $nam, 'uid' => $usid,'uid_type' => "U",'annulled' => $annulled,'timestamp' => $cre), array('%d', '%d', '%d', '%d', '%d', '%s', '%s','%d','%s','%s','%s'));	}	else	{		$ost_wpdb->insert($ticket_event_table, array('ticket_id' => $lastid, 'staff_id' => $staff_id, 'team_id' => $team_id, 'dept_id' => $dep_id, 'topic_id' => $top_id, 'state' => $stat, 'staff' => $staf, 'annulled' => $annulled, 'timestamp' => $cre), array('%d', '%d', '%d', '%d', '%d', '%s', '%s', '%s', '%s'));	} if (!empty($_FILES['file']['name'][0])){       foreach($fileids as $file_id){// File Attachment Table Entry Code Start Here By Pratik Maniar on 29/08/2014if($keyost_version==1914)		{			$ost_wpdb->insert($keyost_prefix . "attachment", array('object_id' => $thread_id, 'type' => 'H', 'file_id' => $file_id,'inline'=>'0'), array('%d', '%s', '%d', '%d'));		}		else		{			$ost_wpdb->insert($keyost_prefix . "ticket_attachment", array('ticket_id' => $lastid, 'file_id' => $file_id, 'ref_id' => $thread_id, 'inline' => '0', 'created' => $cre), array('%d', '%d', '%d', '%d', '%s'));		}       //$ost_wpdb->insert($keyost_prefix . "ticket_attachment", array('ticket_id' => $lastid, 'file_id' => $file_id, 'ref_id' 	=> $thread_id, 'inline' => '0', 'created' => $cre), array('%d', '%d', '%d', '%d', '%s'));// File Attachment Table Entry Code End Here By Pratik Maniar on 29/08/2014    }}if($keyost_version==194 || $keyost_version==195 || $keyost_version==1951 || $keyost_version==1914){    $ost_wpdb->insert($ticket_cdata, array('ticket_id' => $lastid, 'subject' => $sub, 'priority' =>$pri_id), array('%d', '%s',	'%d'));}else{    $ost_wpdb->insert($ticket_cdata, array('ticket_id' => $lastid, 'subject' => $sub, 'priority' => $priordesc, 'priority_id' => $pri_id), array('%d', '%s', '%s', '%d'));}//@$topic_tab = $ost_wpdb->get_results("SELECT topic_id, topic FROM $topic_table WHERE topic_id=@$top_id");//foreach ($topic_tab as $topic_tab1) { //   @$top = $topic_tab1->topic;//}$config_table = $keyost_prefix . "config";$staff_table = $keyost_prefix . "staff";///Variable's for email templates$username = $nam;$usermail = $em;$ticketid = $tic_ID;$user_message = $user_message; ///from post form - now becomes a variable & message$ostitle = $title;@$edate = $date;$dname = $directory;$siteurl = get_permalink();if (isset($_REQUEST['page_id']))    $ticketurl = get_permalink() . "?service=view&ticket=$ticketid";else    $ticketurl = get_permalink() . "&service=view&ticket=$ticketid";//echo the_permalink();$postsubmail = $postsubmail; /// subject in user email (todo's - add field input to WP Email Templates)///Email the user with template$to = $usermail;eval("\$subject=\"$postsubmail\";");eval("\$message=\"$newtickettemp\";");///Email osticket admin - a new ticket has been createdif (key4ce_getKeyValue('ticket_alert_admin') == 1 && key4ce_getKeyValue('ticket_alert_active') == 1) {//Added By Pratik Maniar On 14-06-2014 Code Start Here To Avoid Auto generate by Department Emails    $id_ademail = $ost_wpdb->get_var("SELECT id FROM $config_table WHERE $config_table.key like ('%admin_email%');");    $os_admin_email = $ost_wpdb->get_row("SELECT id,namespace,$config_table.key,$config_table.value,updated FROM $config_table where id = $id_ademail");    $os_admin_email_admin = $os_admin_email->value;//Added By Pratik Maniar On 14-06-2014 Code End Here To Avoid Auto generate by Department Emails    $subject = "New Support Ticket";    $adminmessage = "Hello Admin,<br />A new ticket has been created.<br /><br />";    $adminmessage.="Ticket ID #" . $ticketid . "";    $adminmessage.="<br />----------------------<br />";    $adminmessage.="Name: " . $username . "<br />";    $adminmessage.="Email: " . $usermail . "<br />";    $adminmessage.="Priority: " . $priordesc . "<br />";    $adminmessage.="Department: " . $dept_name . "<br />";    $adminmessage.="Subject: " . $sub . "<br />";    $adminmessage.="<br />----------------------<br />";    $adminmessage.="Message: " . $user_message . "";    $adminmessage.="<br />----------------------<br /><br />";    $adminmessage.="To respond to the ticket, please login to the support ticket system.";    $adminmessage.="<br /><br />";    $adminmessage.="" . site_url() . "";    $adminmessage.="<br />";    $adminmessage.="Your friendly Customer Support System ";    $headers = 'From: ' .$ticket_detail_dept_name. ' <' . $ticket_detail_dept_email . ">\r\n";    add_filter('wp_mail_content_type', create_function('', 'return "text/html"; '));    wp_mail($os_admin_email_admin, $subject, key4ce_wpetss_forum_text('<div style="display: none;">-- do not reply below this line -- <br/><br/></div>' . $adminmessage), $headers);}//Email Notification to Department Of Staff Added by Pratik Maniar on 28-04-2014 Start Here///Email osticket Department - a new ticket has been createdif (key4ce_getKeyValue('ticket_alert_dept_members') == 1 && key4ce_getKeyValue('ticket_alert_active') == 1) {    $staff_details = $ost_wpdb->get_results("SELECT email,firstname,lastname FROM $staff_table WHERE `dept_id` =$dep_id");    $department_staff = count($staff_details);    if ($department_staff > 0) {        foreach ($staff_details as $staff) {            $staff_firstname = $staff->firstname;            $staff_lastname = $staff->lastname;            $staff_email = $staff->email;            $subject = $sub;            $deptmessage = "Hello $staff_firstname $staff_lastname,<br />A new ticket has been created.<br /><br />";            $deptmessage.="Ticket ID #" . $ticketid . "";            $deptmessage.="<br />----------------------<br />";            $deptmessage.="Name: " . $username . "<br />";            $deptmessage.="Email: " . $usermail . "<br />";            $deptmessage.="Priority: " . $priordesc . "<br />";            $deptmessage.="Department: " . $dept_name . "<br />";            $deptmessage.="Subject: " . $subject . "<br />";            $deptmessage.="<br />----------------------<br />";            $deptmessage.="Message: " . $user_message . "";            $deptmessage.="<br />----------------------<br /><br />";            $deptmessage.="To respond to the ticket, please login to the support ticket system.";            $deptmessage.="<br /><br />";            $deptmessage.="" . site_url() . "";            $deptmessage.="<br />";            $deptmessage.="Your friendly Customer Support System ";			  $headers = 'From: ' .$ticket_detail_dept_name. ' <' . $ticket_detail_dept_email . ">\r\n";            //$headers = 'From: ' . $ostitle . ' <' . $adem . ">\r\n";            add_filter('wp_mail_content_type', create_function('', 'return "text/html"; '));            wp_mail($staff_email, $subject, key4ce_wpetss_forum_text('<div style="display: none;">-- do not reply below this line -- <br/><br/></div>' . $deptmessage), $headers);        }    } else {        //If Department User Not Found System Will Send Email To Group Members Of Related Department Added By Pratik Maniar on 16-06-2014 Code Start Here        $getGroups = $ost_wpdb->get_results("SELECT * FROM " . $keyost_prefix . "group_dept_access WHERE `dept_id` =$dep_id");        foreach ($getGroups as $group) {            $group_id = $group->group_id;            $staff_details = $ost_wpdb->get_results("SELECT email,firstname,lastname FROM $staff_table WHERE `group_id` =$group_id");            foreach ($staff_details as $staff) {                $staff_firstname = $staff->firstname;                $staff_lastname = $staff->lastname;                $staff_email = $staff->email;                $subject = $sub;                $deptmessage = "Hello $staff_firstname $staff_lastname,<br />A new ticket has been created.<br /><br />";                $deptmessage.="Ticket ID #" . $ticketid . "";                $deptmessage.="<br />----------------------<br />";                $deptmessage.="Name: " . $username . "<br />";                $deptmessage.="Email: " . $usermail . "<br />";                $deptmessage.="Priority: " . $priordesc . "<br />";                $deptmessage.="Department: " . $dept_name . "<br />";                $deptmessage.="Subject: " . $subject . "<br />";                $deptmessage.="<br />----------------------<br />";                $deptmessage.="Message: " . $user_message . "";                $deptmessage.="<br />----------------------<br /><br />";                $deptmessage.="To respond to the ticket, please login to the support ticket system.";                $deptmessage.="<br /><br />";                $deptmessage.="" . site_url() . "";                $deptmessage.="<br />";                $deptmessage.="Your friendly Customer Support System ";                $headers = 'From: ' .$ticket_detail_dept_name. ' <' . $ticket_detail_dept_email . ">\r\n";				//$headers = 'From: ' . $ostitle . ' <' . $adem . ">\r\n";                add_filter('wp_mail_content_type', create_function('', 'return "text/html"; '));                wp_mail($staff_email, $subject, key4ce_wpetss_forum_text('<div style="display: none;">-- do not reply below this line -- <br/><br/></div>' . $deptmessage), $headers);            }        }        //If Department User Not Found System Will Send Email To Group Members Of Related Department Added By Pratik Maniar on 16-06-2014 Code End Here    }}//Email Notification to Department Of Staff Added by Pratik Maniar on 28-04-2014 End Here//Email Notification to Customer Added by Pratik Maniar on 10-09-2014 start Here//Added By Pratik Maniar On 14-06-2014 Code End Here To Avoid Auto generate by Department Emails//$subject = "New Support Ticket";// $usermessage = "Hello $nam ,<br />Your ticket has been created.<br /><br />";// $usermessage.="Ticket ID #" . $ticketid . "";// $usermessage.="<br />----------------------<br />";//  $usermessage.="Email: " . $usermail . "<br />";// $usermessage.="Priority: " . $priordesc . "<br />";// $usermessage.="Department: " . $dept_name . "<br />";//$usermessage.="Subject: " . $sub . "<br />";//$usermessage.="<br />----------------------<br />";// $usermessage.="Message: " . $user_message . "";//$usermessage.="<br />----------------------<br /><br />";//$usermessage.="To respond to the ticket, please login to the support ticket system.";//$usermessage.="<br /><br />";//$usermessage.="" . site_url() . "";//$usermessage.="<br />";//$usermessage.="Your friendly Customer Support System ";	//echo $adminnewticket_text;	//exit;	//Email Notification to Customer Added by Pratik Maniar on 10-09-2014 end Hereif($keyost_version==1914){	$dept_user_details = $ost_wpdb->get_row("SELECT $ost_email.name,$ost_email.email FROM $dept_table INNER JOIN $ost_email ON $dept_table.email_id=$ost_email.email_id WHERE $dept_table.id=$dep_id");}else{	$dept_user_details = $ost_wpdb->get_row("SELECT $ost_email.name,$ost_email.email FROM $dept_table INNER JOIN $ost_email ON $dept_table.email_id=$ost_email.email_id WHERE $dept_table.dept_id=$dep_id");}$dept_user_name = $dept_user_details->name;$dept_user_email = $dept_user_details->email; $user_email_subject=Format::stripslashes($_REQUEST['user_subject']);$ussubject=Format::stripslashes($_REQUEST['user_subject']);$user_email_template=Format::stripslashes($_REQUEST['user_email_template']);eval("\$user_email_template=\"$user_email_template\";");if($smtp_status=="enable")	$SMTPAuth="true";else	$SMTPAuth="false";	require_once ABSPATH . WPINC . '/class-phpmailer.php';require_once ABSPATH . WPINC . '/class-smtp.php';$phpmailer = new PHPMailer();if($smtp_status=="enable"){    $phpmailer = new PHPMailer();    $phpmailer->SMTPAuth =true;    $phpmailer->Username = $smtp_username;    $phpmailer->Password = $smtp_password;    $phpmailer->isHTML(true);    $phpmailer->CharSet = 'UTF-8';    $phpmailer->IsSMTP(true); // telling the class to use SMTP	$phpmailer->SMTPSecure = $smtp_secure;    $phpmailer->Host  =$smtp_host; // SMTP server    $phpmailer->Port=$smtp_port;    $phpmailer->From =  "$dept_user_email";    $phpmailer->FromName = "$dept_user_name";	add_filter('wp_mail_content_type',create_function('', 'return "text/html"; '));    $phpmailer->Subject    =$user_email_subject;    $phpmailer->Body       = key4ce_wpetss_forum_text($user_email_template);    $phpmailer->AltBody    = "To view the message, please use an HTML compatible email viewer!"; // optional, comment out and test    $phpmailer->MsgHTML('<div style="display: none;">-- do not reply below this line -- <br/><br/></div>' . $user_email_template);    $phpmailer->AddAddress($to);    $phpmailer->Send();}else{    $phpmailer->CharSet = 'UTF-8';    $phpmailer->IsSendmail(); // telling the class to use SendMail transport	$phpmailer->isHTML(true);    $phpmailer->CharSet = 'UTF-8';    $phpmailer->AddReplyTo("$dept_user_email","$dept_user_name");    $phpmailer->From =  "$dept_user_email";    $phpmailer->FromName = "$dept_user_name";    $phpmailer->AddAddress($to, $usname);	add_filter('wp_mail_content_type',create_function('', 'return "text/html"; '));    $phpmailer->Subject    =$user_email_subject;    $phpmailer->Body       = key4ce_wpetss_forum_text($user_email_template);    $phpmailer->AltBody    = "To view the message, please use an HTML compatible email viewer!";    $phpmailer->MsgHTML('<div style="display: none;">-- do not reply below this line -- <br/><br/></div>' . $user_email_template);    $phpmailer->Send();	//exit;}?>